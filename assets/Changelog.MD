# Changelog

## v1.4.0 â€” Phase 3 & 4 Complete
*February 2026*

### Added (Phase 3 â€” Dice Engine)
- `rollDice(sides)` â€” single die roll utility
- `getModifier(score)` â€” D&D 5e modifier formula, uses `CSMS_CONFIG.AVERAGE_STAT`
- `formatMod(mod)` â€” signed string formatting (`+2`, `-1`, `+0`)
- `statMod(score)` â€” convenience wrapper: getModifier + formatMod
- `resolveRoll(notation, character, mode)` â€” full roll engine
  - Parses `XdY+STAT` notation
  - Supports `normal`, `advantage`, `disadvantage` modes
  - Returns `{ total, rolls, modifier, breakDown }` object
  - Breakdown string format: `1d20+DEX = [14] + DEX(+2) = 16`
- `AVERAGE_STAT: 10` â€” configurable base for modifier calculation
- `DEFAULT_STAT: 10` â€” initial stat value on character creation
- `DEFAULT_HP`, `DEFAULT_AC`, `DEFAULT_SPEED` â€” configurable character defaults

### Added (Phase 4 â€” Roll Command)
- `/csms roll [action]` command â€” player-initiated roll
- `handleRoll(param)` â€” action text extraction with position-independent command parsing
- `state.csmsRollPending` â€” persists action text across hooks during roll flow
- Context hook stat question injection â€” prompts AI for single stat word
- `rollCheck()` â€” stat detection, roll execution, output replacement
  - Full/abbreviated stat name matching (Dexterity, DEX, dex all caught)
  - Roll breakdown notification shown to player
  - `##` instruction injected for AI narrative on Continue
  - Retry prompt if AI fails to return a valid stat
- Multiplayer-compatible action text cleaning â€” strips `> You` / `> CharacterName` prefixes

### Added (Config)
- `MODULES` block â€” `CHARACTER_SHEETS`, `COMBAT`, `FEATS`, `INVENTORY` toggles
- `INVENTORY: false` â€” marked as future, not yet implemented

---

## v1.3.0 â€” Phase 2 Complete
*February 2026*

### Added
- `isCharacterSheet(card, name)` â€” identifies valid CS cards by `ðŸ“‹` emoji OR `csms_cs_` key
- `getTaggedCards()` â€” scans storyCards for `AUTO_GENERATION_TAG` prefix
- `getTaggedName(card)` â€” extracts clean name from tagged card, strips emoji and tag
- `processTaggedCards()` â€” full tag detection and branching logic, runs in context hook
- `generateNarrativeSheet()` â€” output hook intercepts AI stat response, creates sheet silently
- `state.csmsPending` â€” single-item generation queue, one character at a time
- `AUTO_GENERATION_TAG: "[CSMS]"` â€” configurable tag in `CSMS_CONFIG`
- Three-branch tag processing â€” handles separate CS / tagged card is CS / no CS cases
- Stats stripped from visible output after generation â€” player never sees raw stat string
- Tag removed from original card title after sheet generated

### Fixed
- Empty string guard in multiplayer auto-create â€” prevents blank sheets from empty `info.characters` entries

---

## v1.2.0 â€” Phase 1.5 Complete
*February 2026*

### Added
- `parseCharacterCard(character)` â€” position-based SC parser, label-agnostic regex
- `safeInt()` â€” value validation with fallback and error notification
- `/csms sync [name]` â€” manual sync story card edits to state
- Auto-sync on every context hook run
- `injectActiveCharacters()` â€” compact character data injected into `frontMemory`
- `getActivePlayer()` â€” detects active player from input text in multiplayer
- `syncMultiplayerCharacters()` â€” removes sheets for players who left or renamed
- `isMultiplayerCharacter` flag on character objects â€” protects NPCs from multiplayer sync
- Multiplayer auto-create â€” sheets created automatically when players join
- `STAT_MIN`, `STAT_MAX` â€” stat range validation in `CSMS_CONFIG`
- `LOOKBACK_ACTIONS` â€” history scan depth for character detection in `CSMS_CONFIG`
- `INJECTED_SHEET_MAX` â€” max sheets injected per action in `CSMS_CONFIG`
- `BANNED_NAMES` â€” invalid name protection in `CSMS_CONFIG`
- `canCastSpell: false` flag â€” added to `initCharacter()` for future spell system
- SC keyword placeholder `csms_cs_${name}` â€” AC-safe card trigger keys

### Fixed
- `handleReset()` now uses `storedName` for card removal â€” fixes case mismatch bug
- `handleCleanup()` `length` typo fixed

---

## v1.0.0 â€” Phase 1 Complete
*February 2026*

### Added
- `CSMS()` function with input/context/output hooks
- `/csms create [name]` â€” character creation
- `/csms stats [name]` â€” character sheet refresh
- `/csms reset [name]` â€” remove specific character
- `/csms reset` â€” remove all characters
- `/csms cleanup` â€” remove orphaned story cards
- `state.characters[]` â€” multi-character persistent storage
- `initCharacter()` â€” D&D 5e stat foundation
- `findCharacter()` â€” case-insensitive name search
- `getPlayer()` â€” quick player character access
- `updateCharacterCard(character)` â€” dynamic story card sync
- `removeCharacterCard(name)` â€” story card removal
- Individual story cards per character (`ðŸ“‹ Name`)
- Regex-based command detection â€” works in do/say/normal input
- Punctuation stripping from command parameters
- `storedName` fix â€” case-safe card removal
- `CSMS_CONFIG` â€” world maker configuration block

### Added (NotifyThem v1.0.0)
- `initNotify()` â€” debug mode initialization
- `notify(sMessage, dMessage)` â€” message storage + debug logging
- `updateNotification()` â€” flush messages to output as `[bracketed]` block
- `resetNotification()` â€” clear message queue
- `NOTIFY_CONFIG` â€” header and debug mode configuration
- Timestamped debug logs via `log()`
