# CSMS Technical Notes

## AID Environment Discoveries

### globalThis dump (beta, Feb 2026)
```
"global"
"log"           â† native shorthand for console.log
"sandboxConsole"
"storyCards"    â† direct array manipulation works
"worldInfo"
"updateStoryCards"  â† native but unreliable, use storyCards directly
"updateState"       â† native but behavior unclear, use state directly
"state"
"memory"        â† separate from state.memory, don't write to this
"text"
"info"
"history"
```

### Key Findings
- `log()` is a native global shorthand for `console.log()`
- `storyCards.push()` works for creation, direct mutation works for updates
- `updateStoryCards` â€” tested, unreliable. Stick to direct `storyCards` manipulation
- `updateState` â€” tested, doesn't reflect changes. Use `state.x = y` directly
- `memory` global and `state.memory` are SEPARATE objects. Only write to `state.memory`
- Input text always has newline prefix â€” always `.trim()` before processing
- Script doesn't run if AI stutters/lags â€” player must retry, nothing we can do

### state.memory
- `state.memory.context` â€” write to this to override Plot Essentials
- `state.memory.authorsNote` â€” write to this to override Author's Note
- `state.memory.frontMemory` â€” injected before last action, invisible to player
- Both readable and writable confirmed

### storyCard object structure
```js
{
  id: "542586357",              // auto-assigned by AID
  createdAt: "2026-02-23...",   // auto-assigned
  updatedAt: "2026-02-23...",   // auto-assigned
  keys: "keyword1, keyword2",
  entry: "card content here",
  type: "",
  title: "Card Title",
  description: "notes field",
  useForCharacterCreation: false  // undocumented field
}
```

### Known Bugs / Limitations
- `stop: true` in input modifier also suppresses player action from displaying
- Script Test panel unreliable â€” use PLAY + INSPECT workflow instead
- LMI and logs expire after a few minutes â€” keep second tab open while testing
- `updateWorldEntry` throws error if index doesn't exist (no longer silent)

---

## Design Decisions

### Why `state.characters[]` array instead of `state.character`
Multiple characters needed â€” player + NPCs. Array allows `find()`, `findIndex()`, iteration. Single object would require separate storage per character.

### Why `storedName` in handleReset
Player might type "JonaTHan" â€” `findCharacter()` finds it case-insensitively but `removeCharacterCard()` does exact title match. Always use the stored name from state for card operations.

### Why bracketed notifications `[...]`
AI treats bracketed content as out-of-character notes â€” sees it but doesn't narrate it directly. Established AID convention (same as `[Author's note:]`). Keeps narrative clean.

### Why regex scan instead of startsWith for commands
AID prepends `> You` or `> You say, "..."` to do/say inputs. Format changes between versions. Scanning entire input for `/csms` pattern anywhere is future-proof and format-agnostic.

### Why `feedToOutput` removed from notify()
Single responsibility principle. `notify()` just stores messages. `updateNotification()` handles flushing. Cleaner separation.

### Why NotifyThem is separate from CSMS
Independent reusability â€” other scripters can use NotifyThem without CSMS. Publishable as standalone system. Clean separation of concerns.

### Why `CSMS_CONFIG` kept even when empty
Placeholder for future world maker settings. Consistent pattern â€” world makers know to look at top of file for configuration. Better to establish the pattern early.

---

## Command Architecture

```
Player input (any format)
    â†“
Input hook â€” regex scan for /csms anywhere in text
    â†“
parseCommand() â€” extract action and param
    â†“
handle[Action]() â€” execute, return result string
    â†“
notify(result) â€” store in state.notifyMessages
    â†“
Original player text passes to AI unchanged
    â†“
AI generates narrative
    â†“
Output hook â€” updateNotification() prepends [brackets] to output
    â†“
Player sees: [CSMS notification] + AI narrative
```

---

## Compatibility Notes

### Inner Self (LewdLeah)
- IS uses `storyCards` directly â€” compatible
- IS uses `state` â€” compatible, use namespaced keys (state.characters not state.char)
- IS uses `state.memory` â€” compatible, don't overwrite IS memory fields
- Architecture mirrors IS pattern (`InnerSelf("input")` â†’ `CSMS("input")`)

### Auto-Cards
- AC generates cards by character name keywords â€” DANGEROUS overlap
- Solution (planned): change card keys to `csms_cs_CharacterName` â€” unique enough AC won't conflict
- Inject keyword into context so AI can still reference sheet

### General compatibility rule
- Always namespace state variables: `state.characters`, `state.notifyMessages` etc
- Never use generic keys that other scripts might use
- `ðŸ“‹` emoji prefix on card titles â€” distinctive enough to avoid conflicts

---

## File Structure
```
library.js      â€” Main script (NotifyThem + CSMS)
README.md       â€” Public documentation
MILESTONES.md   â€” Phase tracking
NOTES.md        â€” This file
CHANGELOG.md    â€” Version history
```

---

## Context Recovery (for new Claude sessions)
Paste this at start of conversation:
*"Here's our AID CSMS project: [raw GitHub URL of library.js] and [raw GitHub URL of NOTES.md]. Read both and let's continue from Phase 1.5."*

Claude will fetch both files and be fully up to speed.
